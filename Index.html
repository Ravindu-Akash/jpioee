<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JPI – OEE Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --success: #06d6a0;
            --danger: #ef476f;
            --light: #ffffff;
            --gray: #f8f9fa;
            --border: #dee2e6;
            --text: #212529;
            --label: #495057;
        }
        body { background: #f8f9fa; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; color: var(--text); margin: 0; padding: 0; }
        .navbar { background: white; border-bottom: 1px solid var(--border); box-shadow: 0 2px 10px rgba(0,0,0,.05); }
#datePicker {
    font-size: 1rem;
    cursor: pointer;
}
#datePicker::-webkit-calendar-picker-indicator {
    opacity: 0.7;
    cursor: pointer;
}
        .navbar-brand { font-weight: 700; color: var(--primary) !important; }
        .hero { background: linear-gradient(135deg, #eef2ff, #d0e0ff); padding: 4rem 2rem; border-radius: 1.5rem; margin: 2rem 0; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,.08); }
        .hero h1 { font-weight: 800; color: var(--primary); margin-bottom: 1rem; }
        .hero p { font-size: 1.1rem; color: #555; max-width: 700px; margin: 0 auto 2rem; font-weight: 500; }
        .login-section { background: white; border-radius: 1rem; padding: 2rem; margin: 1rem auto; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,.05); display: none; }
        .login-section h4 { color: var(--primary); margin-bottom: 1rem; }
        .login-section input { margin-bottom: 1rem; }
        .login-btn { background: var(--primary); color: white; border: none; padding: .75rem 1.5rem; border-radius: .5rem; width: 100%; font-weight: 600; }
        .login-btn:hover { background: #3651d4; }
        .logout-btn { background: var(--danger); color: white; border: none; padding: .5rem 1rem; border-radius: .5rem; font-size: .9rem; margin-left: 1rem; }
        .auth-status { text-align: right; padding: 1rem; background: #f8f9ff; border-radius: .75rem; margin: 1rem 0; }
        .read-only { background: #fff3cd !important; color: #856404 !important; border-color: #ffeaa7 !important; }
        .shift-selector { text-align: center; margin: 2rem 0; }
        .shift-selector label { font-weight: 600; margin-right: 1rem; }
        .shift-selector select { display: inline-block; width: auto; max-width: 200px; }
        .section-tabs { display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin: 3rem 0; }
        .tab-card { background: white; border: 1px solid var(--border); border-radius: 1rem; padding: 2rem; width: 280px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,.05); transition: all 0.3s ease; cursor: pointer; }
        .tab-card:hover { transform: translateY(-8px); box-shadow: 0 12px 30px rgba(0,0,0,.12); border-color: var(--primary); }
        .tab-card i { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; }
        .tab-card h3 { font-weight: 700; color: var(--text); margin-bottom: .5rem; }
        .tab-card p { color: #6c757d; font-size: .95rem; }
        .tab-card .badge { background: var(--primary); color: white; font-size: .8rem; padding: .4em .8em; border-radius: 50px; margin-top: .75rem; display: inline-block; }
        .search-container { max-width: 600px; margin: 3rem auto 2rem; position: relative; }
        .search-input-group { display: flex; box-shadow: 0 6px 20px rgba(0,0,0,.08); border-radius: 1rem; overflow: hidden; }
        .search-input { flex: 1; padding: 1rem 1.5rem; font-size: 1.1rem; border: none; outline: none; background: white; }
        .search-btn { background: var(--primary); color: white; border: none; padding: 0 2rem; font-weight: 600; display: flex; align-items: center; gap: .5rem; transition: all 0.3s ease; }
        .search-btn:hover { background: #3651d4; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border); border-top: none; border-radius: 0 0 1rem 1rem; max-height: 300px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 8px 25px rgba(0,0,0,.1); }
        .search-result-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center; }
        .search-result-item:hover { background: #f0f4ff; }
        .search-result-name { font-weight: 600; color: var(--primary); }
        .search-result-oee { font-weight: 700; color: var(--success); font-size: 1.1rem; }
        .no-results { padding: 1.5rem; text-align: center; color: #6c757d; font-style: italic; }
        .action-buttons { display: flex; justify-content: center; gap: 1rem; margin: 2rem auto; flex-wrap: wrap; }
        .show-oee-btn, .export-excel-btn, .clear-data-btn { background: var(--primary); color: white; border: none; border-radius: 1rem; padding: 1rem 2rem; font-weight: 600; font-size: 1.1rem; display: flex; align-items: center; gap: .75rem; box-shadow: 0 6px 20px rgba(67,97,238,.3); transition: all 0.3s ease; cursor: pointer; }
        .show-oee-btn:hover, .export-excel-btn:hover, .clear-data-btn:hover { background: #3651d4; transform: translateY(-3px); box-shadow: 0 10px 25px rgba(67,97,238,.4); }
        .export-excel-btn { background: #16a34a !important; }
        .export-excel-btn:hover { background: #138843 !important; }
        .clear-data-btn { background: #dc3545 !important; }
        .clear-data-btn:hover { background: #c82333 !important; }
        .btn-disabled { background: #6c757d !important; cursor: not-allowed !important; transform: none !important; opacity: 0.6; }
        .oee-charts { display: none; margin-top: 3rem; padding: 2rem; background: white; border-radius: 1.5rem; box-shadow: 0 8px 30px rgba(0,0,0,.08); }
        .chart-container { height: 320px; margin-bottom: 2rem; position: relative; }
        .chart-title { text-align: center; font-weight: 700; color: var(--primary); margin-bottom: 1.5rem; font-size: 1.3rem; display: flex; align-items: center; justify-content: center; gap: .5rem; }
        .page-header { background: linear-gradient(135deg, #eef2ff, #d0e0ff); padding: 1.5rem; border-radius: 1rem; margin: 2rem 0 1rem; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,.05); }
        .page-header h2 { font-weight: 700; color: var(--primary); margin: 0; font-size: 1.4rem; }
        .back-btn { position: fixed; top: 6rem; left: 2rem; z-index: 1000; background: white; border: 1px solid var(--border); border-radius: .75rem; padding: .75rem 1rem; box-shadow: 0 4px 12px rgba(0,0,0,.1); color: var(--primary); font-weight: 600; text-decoration: none; display: flex; align-items: center; gap: .5rem; transition: all 0.3s ease; }
        .back-btn:hover { background: var(--primary); color: white; transform: translateX(-5px); }
        .machine-container { background: white; border: 1px solid var(--border); border-radius: 1.25rem; padding: 2rem; margin: 2rem 0; box-shadow: 0 6px 20px rgba(0,0,0,.07); max-width: 900px; margin-left: auto; margin-right: auto; }
        .machine-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border); }
        .machine-header h3 { margin: 0; font-weight: 700; color: var(--primary); font-size: 1.5rem; display: flex; align-items: center; gap: .75rem; }
        .machine-header i { color: var(--primary); font-size: 1.6rem; }
        .machine-header input { font-weight: 600; color: var(--primary); border: none; background: transparent; font-size: 1.3rem; padding: .25rem .5rem; border-radius: .5rem; width: 180px; text-align: center; }
        .machine-header input:focus { outline: none; background: #f0f4ff; }
        .input-group { margin-bottom: .75rem; }
        .input-group-text { background: #f1f3f5; border-right: none; color: var(--label); font-weight: 600; font-size: .9rem; min-width: 140px; justify-content: flex-end; }
        .form-control { border-left: none; background: white; font-weight: 500; }
        .form-control:focus { box-shadow: 0 0 0 .2rem rgba(67,97,238,.15); border-color: var(--primary); }
        .input-group:focus-within .input-group-text, .input-group:focus-within .form-control { border-color: var(--primary); }
        .section-title { background: #eef2ff; color: var(--primary); font-weight: 700; padding: .5rem .75rem; border-radius: .75rem; margin: 1.5rem 0 .75rem; font-size: .95rem; display: flex; align-items: center; gap: .5rem; }
        .alert { border-radius: .75rem; font-size: .85rem; background: #f8f9ff; border: 1px solid #e0e7ff; color: var(--text); padding: .75rem; }
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px dashed var(--border); }
        .metric-card { background: #f8f9ff; border: 1px solid #e0e7ff; border-radius: .75rem; padding: .75rem; text-align: center; transition: all 0.2s ease; }
        .metric-card:hover { background: #eef2ff; transform: scale(1.03); }
        .metric-label { font-size: .8rem; color: var(--label); margin-bottom: .25rem; font-weight: 600; }
        .metric-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .metric-oee { font-size: 1.7rem !important; color: var(--success) !important; }
        .quality-ok { color: var(--success); font-weight: bold; font-size: .8rem; }
        .nav-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding: 1rem 0; border-top: 1px solid var(--border); }
        .nav-btn { background: var(--primary); color: white; border: none; border-radius: .75rem; padding: .75rem 1.5rem; font-weight: 600; font-size: 1rem; display: flex; align-items: center; gap: .5rem; transition: all 0.3s ease; min-width: 130px; justify-content: center; cursor: pointer; }
        .nav-btn:hover { background: #3651d4; transform: translateY(-2px); }
        .nav-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .machine-counter { font-weight: 600; color: var(--primary); font-size: 1.1rem; }
        .scroll-to-top { position: fixed; bottom: 2rem; right: 2rem; width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(67,97,238,.3); cursor: pointer; z-index: 1000; transition: all 0.3s ease; }
        .scroll-to-top:hover { background: #3651d4; transform: scale(1.1); }
        .page { display: none; }
        .page.active { display: block; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .summary-card { background: white; border: 1px solid var(--border); border-radius: 0.9rem; padding: 1.2rem; box-shadow: 0 3px 12px rgba(0,0,0,.04); text-align: center; transition: all 0.3s ease; font-size: 0.9rem; }
        .summary-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
        .summary-card h4 { font-weight: 700; color: var(--primary); margin-bottom: 0.4rem; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 0.4rem; }
        .summary-card h4 i { font-size: 1rem; }
        .summary-card .avg-value { font-size: 1.6rem; font-weight: 800; color: var(--success); margin: 0.4rem 0; }
        .summary-card .count { font-size: 0.8rem; color: #6c757d; font-weight: 500; }
        .factory-oee-card { background: linear-gradient(135deg, #4361ee, #3651d4); color: white; border: none; }
        .factory-oee-card h4, .factory-oee-card .count { color: white; }
        .factory-oee-card .avg-value { color: #a0f1ea; }
        .data-saved-alert { position: fixed; top: 1rem; right: 1rem; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: .75rem 1.5rem; border-radius: .75rem; font-weight: 600; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        .loading { display: none; text-align: center; padding: 2rem; color: var(--primary); }
        .read-only-msg { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: .75rem; padding: 1rem; margin: 1rem 0; color: #856404; text-align: center; font-weight: 500; }
        @media (max-width: 768px) { .action-buttons { flex-direction: column; } .show-oee-btn, .export-excel-btn, .clear-data-btn { width: 100%; max-width: 300px; } }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="showPage('home'); return false;">
                <i class="fas fa-cogs me-2"></i>JPI OEE
            </a>
            <span class="navbar-text ms-auto">
                <i class="fas fa-calendar-alt me-1"></i>
                <span id="current-time"></span>
                <div id="auth-status" class="auth-status" style="display: none;">
                    <span id="user-info"></span>
                    <button id="logout-btn" class="logout-btn" onclick="logoutUser()" style="display: none;">Logout</button>
                </div>
            </span>
        </div>
    </nav>
    <!-- Loading Indicator -->
    <div id="loading" class="loading container py-4">
        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
        <p>Loading data from Firebase...</p>
    </div>
    <!-- Home Page -->
    <div id="home" class="page active container py-4">
        <div class="hero">
            <h1>Jayasinghe Plastic Industries OEE dashboard</h1>
            <p>Track <strong>OEE = Availability × Performance × Quality</strong></p>
            <div id="login-section" class="login-section">
                <h4><i class="fas fa-sign-in-alt"></i> Login to Edit Data</h4>
                <input type="email" id="login-email" class="form-control" placeholder="Email" />
                <input type="password" id="login-password" class="form-control" placeholder="Password" />
                <button class="login-btn" onclick="loginUser()">Login</button>
                <p class="text-muted small mt-2">Use your Firebase account (email/password). Only authorized users can save.</p>
            </div>
        </div>
        <nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand" href="#" onclick="showPage('home'); return false;">
            <i class="fas fa-cogs me-2"></i>JPI OEE
        </a>
        
        <div class="ms-auto d-flex align-items-center gap-3">
            <!-- Date Picker -->
            <div class="d-flex align-items-center bg-white rounded-3 shadow-sm px-3 py-2 border">
                <i class="fas fa-calendar-alt text-primary me-2"></i>
                <input type="date" id="datePicker" class="form-control border-0 shadow-none" style="width: auto; font-weight: 600;">
            </div>

            <!-- Clock -->
            <span class="navbar-text">
                <i class="fas fa-clock me-1"></i>
                <span id="current-time"></span>
            </span>

            <!-- Auth Status -->
            <div id="auth-status" class="auth-status" style="display: none;">
                <span id="user-info"></span>
                <button id="logout-btn" class="logout-btn" onclick="logoutUser()" style="display: none;">Logout</button>
            </div>
        </div>
    </div>
        <div id="read-only-msg" class="read-only-msg" style="display: none;">Viewing in read-only mode. <a href="#" onclick="showLogin()">Login to edit</a>.</div>
        <div class="shift-selector">
            <label for="shiftSelector">Select Shift for Entry:</label>
            <select id="shiftSelector" class="form-select">
                <option value="day">Day Shift</option>
                <option value="night">Night Shift</option>
            </select>
        </div>
        <!-- A, P, Q + OEE Averages -->
        <div class="summary-cards">
            <div class="summary-card factory-oee-card" id="factory-oee-card" style="display:none;">
                <h4><i class="fas fa-building"></i> Factory OEE</h4>
                <div class="avg-value" id="avg-factory">0.00%</div>
                <div class="count">Overall Plant Performance</div>
            </div>
            <div class="summary-card" id="day-oee-card" style="display:none;">
                <h4><i class="fas fa-sun"></i> Day Shift OEE</h4>
                <div class="avg-value" id="avg-day">0.00%</div>
                <div class="count">Day Shift Performance</div>
            </div>
            <div class="summary-card" id="night-oee-card" style="display:none;">
                <h4><i class="fas fa-moon"></i> Night Shift OEE</h4>
                <div class="avg-value" id="avg-night">0.00%</div>
                <div class="count">Night Shift Performance</div>
            </div>
            <div class="summary-card">
                <h4><i class="fas fa-industry"></i> IM Section (Day)</h4>
                <div class="avg-value" id="oee-im-day">0.00%</div>
                <div class="count" id="count-im-day">0 / 33 machines</div>
                <div class="d-flex justify-content-around mt-2">
                    <div><small>A: <strong id="a-im-day">0.00%</strong></small></div>
                    <div><small>P: <strong id="p-im-day">0.00%</strong></small></div>
                    <div><small>Q: <strong id="q-im-day">100.00%</strong></small></div>
                </div>
            </div>
            <div class="summary-card">
                <h4><i class="fas fa-wind"></i> BM Section (Day)</h4>
                <div class="avg-value" id="oee-bm-day">0.00%</div>
                <div class="count" id="count-bm-day">0 / 17 machines</div>
                <div class="d-flex justify-content-around mt-2">
                    <div><small>A: <strong id="a-bm-day">0.00%</strong></small></div>
                    <div><small>P: <strong id="p-bm-day">0.00%</strong></small></div>
                    <div><small>Q: <strong id="q-bm-day">100.00%</strong></small></div>
                </div>
            </div>
            <div class="summary-card">
                <h4><i class="fas fa-tag"></i> IML Section (Day)</h4>
                <div class="avg-value" id="oee-iml-day">0.00%</div>
                <div class="count" id="count-iml-day">0 / 10 machines</div>
                <div class="d-flex justify-content-around mt-2">
                    <div><small>A: <strong id="a-iml-day">0.00%</strong></small></div>
                    <div><small>P: <strong id="p-iml-day">0.00%</strong></small></div>
                    <div><small>Q: <strong id="q-iml-day">100.00%</strong></small></div>
                </div>
            </div>
            <div class="summary-card">
                <h4><i class="fas fa-industry"></i> IM Section (Night)</h4>
                <div class="avg-value" id="oee-im-night">0.00%</div>
                <div class="count" id="count-im-night">0 / 33 machines</div>
                <div class="d-flex justify-content-around mt-2">
                    <div><small>A: <strong id="a-im-night">0.00%</strong></small></div>
                    <div><small>P: <strong id="p-im-night">0.00%</strong></small></div>
                    <div><small>Q: <strong id="q-im-night">100.00%</strong></small></div>
                </div>
            </div>
            <div class="summary-card">
                <h4><i class="fas fa-wind"></i> BM Section (Night)</h4>
                <div class="avg-value" id="oee-bm-night">0.00%</div>
                <div class="count" id="count-bm-night">0 / 17 machines</div>
                <div class="d-flex justify-content-around mt-2">
                    <div><small>A: <strong id="a-bm-night">0.00%</strong></small></div>
                    <div><small>P: <strong id="p-bm-night">0.00%</strong></small></div>
                    <div><small>Q: <strong id="q-bm-night">100.00%</strong></small></div>
                </div>
            </div>
            <div class="summary-card">
                <h4><i class="fas fa-tag"></i> IML Section (Night)</h4>
                <div class="avg-value" id="oee-iml-night">0.00%</div>
                <div class="count" id="count-iml-night">0 / 10 machines</div>
                <div class="d-flex justify-content-around mt-2">
                    <div><small>A: <strong id="a-iml-night">0.00%</strong></small></div>
                    <div><small>P: <strong id="p-iml-night">0.00%</strong></small></div>
                    <div><small>Q: <strong id="q-iml-night">100.00%</strong></small></div>
                </div>
            </div>
        </div>
        <!-- Section Tabs -->
        <div class="section-tabs">
            <div class="tab-card" onclick="initSection('im', 33, 'Injection Molding (IM)', 'fas fa-industry')">
                <i class="fas fa-industry"></i>
                <h3>Injection Molding</h3>
                <p>IM Machines</p>
                <div class="badge">33 Machines</div>
            </div>
            <div class="tab-card" onclick="initSection('bm', 17, 'Blow Molding (BM)', 'fas fa-wind')">
                <i class="fas fa-wind"></i>
                <h3>Blow Molding</h3>
                <p>BM Machines</p>
                <div class="badge">17 Machines</div>
            </div>
            <div class="tab-card" onclick="initSection('iml', 10, 'In-Mold Labeling (IML)', 'fas fa-tag')">
                <i class="fas fa-tag"></i>
                <h3>In-Mold Labeling</h3>
                <p>IML Machines</p>
                <div class="badge">10 Machines</div>
            </div>
        </div>
        <!-- Search + Buttons -->
        <div class="search-container">
            <div class="search-input-group">
                <input type="text" class="search-input" placeholder="Search by name or ID..." autocomplete="off">
                <button class="search-btn"><i class="fas fa-search"></i> Search</button>
            </div>
            <div id="search-results" class="search-results"></div>
        </div>
        <div class="action-buttons">
            <button class="show-oee-btn" onclick="toggleOEECharts()">
                <i class="fas fa-chart-line"></i> Show OEE Graphs
            </button>
            <button class="export-excel-btn" id="export-btn" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
            <button class="clear-data-btn" id="clear-btn" onclick="clearAllData()">
                <i class="fas fa-trash-alt"></i> Clear All Data
            </button>
        </div>
        <!-- Charts -->
        <div id="oee-charts" class="oee-charts container">
            <div class="row">
                <div class="col-lg-4">
                    <div class="chart-title"><i class="fas fa-industry"></i> IM Machines OEE (Day)</div>
                    <div class="chart-container"><canvas id="imChart-day"></canvas></div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-title"><i class="fas fa-wind"></i> BM Machines OEE (Day)</div>
                    <div class="chart-container"><canvas id="bmChart-day"></canvas></div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-title"><i class="fas fa-tag"></i> IML Machines OEE (Day)</div>
                    <div class="chart-container"><canvas id="imlChart-day"></canvas></div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-4">
                    <div class="chart-title"><i class="fas fa-industry"></i> IM Machines OEE (Night)</div>
                    <div class="chart-container"><canvas id="imChart-night"></canvas></div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-title"><i class="fas fa-wind"></i> BM Machines OEE (Night)</div>
                    <div class="chart-container"><canvas id="bmChart-night"></canvas></div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-title"><i class="fas fa-tag"></i> IML Machines OEE (Night)</div>
                    <div class="chart-container"><canvas id="imlChart-night"></canvas></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Machine Entry Page -->
    <div id="section-page" class="page container py-4" style="margin-top: 4rem;">
        <a href="#" class="back-btn" onclick="showPage('home'); return false;">
            <i class="fas fa-arrow-left"></i> Back
        </a>
        <div class="page-header">
            <h2 id="section-title"></h2>
        </div>
        <div id="machine-container"></div>
    </div>
    <div id="scrollTop" class="scroll-to-top"><i class="fas fa-arrow-up"></i></div>
    <div id="data-saved-alert" class="data-saved-alert">Data saved!</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Your Firebase Config (unchanged)
        const firebaseConfig = {
            apiKey: "AIzaSyABor7ZDaPfwi2dgqmoU5XxhquU7_0Tqxg",
            authDomain: "jpi-oee-dashboard.firebaseapp.com",
            databaseURL: "https://jpi-oee-dashboard-default-rtdb.firebaseio.com",
            projectId: "jpi-oee-dashboard",
            storageBucket: "jpi-oee-dashboard.firebasestorage.app",
            messagingSenderId: "1097687079271",
            appId: "1:1097687079271:web:d61efb945ac44a076eb7c2"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const WRITER_UID = '6xlNwEqhKOPYeRRvDsZ1alqwsqw2'; // Your specific UID

        // Auth Listener
        auth.onAuthStateChanged((user) => {
            const statusDiv = document.getElementById('auth-status');
            const loginSection = document.getElementById('login-section');
            const readOnlyMsg = document.getElementById('read-only-msg');
            const exportBtn = document.getElementById('export-btn');
            const clearBtn = document.getElementById('clear-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userInfo = document.getElementById('user-info');

            if (user) {
                userInfo.textContent = `Logged in: ${user.email}`;
                logoutBtn.style.display = 'inline-block';
                statusDiv.style.display = 'block';
                loginSection.style.display = 'none';
                readOnlyMsg.style.display = 'none';
                if (user.uid === WRITER_UID) {
                    exportBtn.classList.remove('btn-disabled');
                    clearBtn.classList.remove('btn-disabled');
                } else {
                    exportBtn.classList.add('btn-disabled');
                    clearBtn.classList.add('btn-disabled');
                    alert('Logged in, but not authorized to write. Contact admin.');
                    logoutUser();
                }
            } else {
                userInfo.textContent = 'Not logged in';
                logoutBtn.style.display = 'none';
                statusDiv.style.display = 'none';
                loginSection.style.display = 'none';
                readOnlyMsg.style.display = 'block';
                exportBtn.classList.add('btn-disabled');
                clearBtn.classList.add('btn-disabled');
            }
            updateUIForAuth();
        });

        // Helper: Check if current user is writer
        function isWriter() {
            const user = auth.currentUser;
            return user && user.uid === WRITER_UID;
        }

        // Update UI based on auth (e.g., disable inputs if not writer)
        function updateUIForAuth() {
            // In machine entry, inputs are read-only if not writer (handled in loadMachine)
            if (!isWriter()) {
                // Add read-only class to action buttons (already done via classes)
            }
        }

        // Login Function
        function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) {
                alert('Please enter email and password.');
                return;
            }
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    document.getElementById('login-section').style.display = 'none';
                    alert('Logged in successfully!');
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    alert('Login failed: ' + error.message + '. Check credentials.');
                });
        }

        // Logout Function
        function logoutUser() {
            auth.signOut().then(() => {
                alert('Logged out.');
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        }

        // Show/Hide Login
        function showLogin() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('login-email').focus();
        }

        // Clock (unchanged)
        function updateClock() {
            const now = new Date();
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Colombo' };
            document.getElementById('current-time').textContent = now.toLocaleString('en-US', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Data Structure (unchanged)
        let machineData = {
            day: {
                im: Array(33).fill().map(() => ({ oee: 0, a: 0, p: 0, q: 100, name: '', hasData: false, plannedQty: 0, targetPerHour: 0, cavityCount: 1, breakdownTime: 0, mouldChangeTime: 0, lackOperatorTime: 0, itemClearTime: 0, machineStartedTime: 0, othersTime: 0, damageQty: 0 })),
                bm: Array(17).fill().map(() => ({ oee: 0, a: 0, p: 0, q: 100, name: '', hasData: false, plannedQty: 0, targetPerHour: 0, cavityCount: 1, breakdownTime: 0, mouldChangeTime: 0, lackOperatorTime: 0, itemClearTime: 0, machineStartedTime: 0, othersTime: 0, damageQty: 0 })),
                iml: Array(10).fill().map(() => ({ oee: 0, a: 0, p: 0, q: 100, name: '', hasData: false, plannedQty: 0, targetPerHour: 0, cavityCount: 1, breakdownTime: 0, mouldChangeTime: 0, lackOperatorTime: 0, itemClearTime: 0, machineStartedTime: 0, othersTime: 0, damageQty: 0 }))
            },
            night: {
                im: Array(33).fill().map(() => ({ oee: 0, a: 0, p: 0, q: 100, name: '', hasData: false, plannedQty: 0, targetPerHour: 0, cavityCount: 1, breakdownTime: 0, mouldChangeTime: 0, lackOperatorTime: 0, itemClearTime: 0, machineStartedTime: 0, othersTime: 0, damageQty: 0 })),
                bm: Array(17).fill().map(() => ({ oee: 0, a: 0, p: 0, q: 100, name: '', hasData: false, plannedQty: 0, targetPerHour: 0, cavityCount: 1, breakdownTime: 0, mouldChangeTime: 0, lackOperatorTime: 0, itemClearTime: 0, machineStartedTime: 0, othersTime: 0, damageQty: 0 })),
                iml: Array(10).fill().map(() => ({ oee: 0, a: 0, p: 0, q: 100, name: '', hasData: false, plannedQty: 0, targetPerHour: 0, cavityCount: 1, breakdownTime: 0, mouldChangeTime: 0, lackOperatorTime: 0, itemClearTime: 0, machineStartedTime: 0, othersTime: 0, damageQty: 0 }))
            }
        };

        // Firebase Database Reference (unchanged)
        const dataRef = db.ref('jpi_oee_data_v2');

        // Load Data from Firebase (unchanged - public read)
        function loadData() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            dataRef.once('value').then((snapshot) => {
                const saved = snapshot.val();
                if (saved) {
                    ['day', 'night'].forEach(shift => {
                        if (saved[shift]) {
                            ['im', 'bm', 'iml'].forEach(sec => {
                                if (saved[shift][sec] && Array.isArray(saved[shift][sec])) {
                                    machineData[shift][sec] = saved[shift][sec].map(m => ({
                                        oee: m.oee || 0, a: m.a || 0, p: m.p || 0, q: m.q || 100,
                                        name: m.name || '', hasData: m.hasData || false,
                                        plannedQty: m.plannedQty || 0, targetPerHour: m.targetPerHour || 0,
                                        cavityCount: m.cavityCount || 1, breakdownTime: m.breakdownTime || 0,
                                        mouldChangeTime: m.mouldChangeTime || 0, lackOperatorTime: m.lackOperatorTime || 0,
                                        itemClearTime: m.itemClearTime || 0, machineStartedTime: m.machineStartedTime || 0,
                                        othersTime: m.othersTime || 0, damageQty: m.damageQty || 0
                                    }));
                                }
                            });
                        }
                    });
                }
                loading.style.display = 'none';
                updateAverages();
            }).catch((error) => {
                console.error("Failed to load data:", error);
                loading.style.display = 'none';
                alert("Failed to load data from Firebase. Check console for details.");
            });
        }

        // Save Data to Firebase (updated with auth check)
        function saveData() {
            if (!isWriter()) {
                showLogin();
                return;
            }
            dataRef.set(machineData).then(() => {
                const alert = document.getElementById('data-saved-alert');
                alert.style.opacity = '1';
                setTimeout(() => alert.style.opacity = '0', 1500);
            }).catch((error) => {
                console.error("Failed to save data:", error);
                alert("Failed to save data to Firebase. Check if you're authorized.");
            });
        }

        // Clear All Data (updated with auth check)
        function clearAllData() {
            if (!isWriter()) {
                showLogin();
                return;
            }
            if (confirm('Are you sure you want to delete ALL saved data? This cannot be undone.')) {
                dataRef.remove().then(() => {
                    location.reload();
                }).catch((error) => {
                    console.error("Failed to clear data:", error);
                    alert("Failed to clear data from Firebase.");
                });
            }
        }

        let currentSection = null, currentShift = 'day', currentIndex = 0, totalMachines = 0, charts = {}, chartsVisible = false;

        // Update Averages (unchanged)
        function updateAverages() {
            const sections = { im: 33, bm: 17, iml: 10 };
            let dayTotalOee = 0, dayValidSections = 0;
            let nightTotalOee = 0, nightValidSections = 0;
            ['day', 'night'].forEach(shift => {
                let totalOee = 0, validSections = 0;
                Object.keys(sections).forEach(sec => {
                    const data = machineData[shift][sec];
                    const filled = data.filter(m => m.hasData);
                    const count = filled.length;
                    const sumOee = filled.reduce((a, m) => a + m.oee, 0);
                    const sumA = filled.reduce((a, m) => a + m.a, 0);
                    const sumP = filled.reduce((a, m) => a + m.p, 0);
                    const sumQ = filled.reduce((a, m) => a + m.q, 0);
                    const avgOee = count > 0 ? sumOee / count : 0;
                    const avgA = count > 0 ? sumA / count : 0;
                    const avgP = count > 0 ? sumP / count : 0;
                    const avgQ = count > 0 ? sumQ / count : 100;
                    const el = (id) => document.getElementById(id);
                    el(`oee-${sec}-${shift}`).textContent = avgOee.toFixed(2) + '%';
                    el(`a-${sec}-${shift}`).textContent = avgA.toFixed(2) + '%';
                    el(`p-${sec}-${shift}`).textContent = avgP.toFixed(2) + '%';
                    el(`q-${sec}-${shift}`).textContent = avgQ.toFixed(2) + '%';
                    el(`count-${sec}-${shift}`).textContent = `${count} / ${sections[sec]} machines`;
                    if (count > 0) { totalOee += avgOee; validSections++; }
                });
                if (shift === 'day') {
                    dayTotalOee = totalOee;
                    dayValidSections = validSections;
                    const dayAvgEl = document.getElementById('avg-day');
                    const dayCard = document.getElementById('day-oee-card');
                    if (validSections > 0) {
                        dayAvgEl.textContent = (totalOee / validSections).toFixed(2) + '%';
                        dayCard.style.display = 'block';
                    } else {
                        dayCard.style.display = 'none';
                    }
                } else {
                    nightTotalOee = totalOee;
                    nightValidSections = validSections;
                    const nightAvgEl = document.getElementById('avg-night');
                    const nightCard = document.getElementById('night-oee-card');
                    if (validSections > 0) {
                        nightAvgEl.textContent = (totalOee / validSections).toFixed(2) + '%';
                        nightCard.style.display = 'block';
                    } else {
                        nightCard.style.display = 'none';
                    }
                }
            });
            const factoryCard = document.getElementById('factory-oee-card');
            const factoryAvgEl = document.getElementById('avg-factory');
            let factoryOee = 0;
            let totalValidShifts = 0;
            if (dayValidSections > 0) {
                factoryOee += dayTotalOee / dayValidSections;
                totalValidShifts++;
            }
            if (nightValidSections > 0) {
                factoryOee += nightTotalOee / nightValidSections;
                totalValidShifts++;
            }
            if (totalValidShifts > 0) {
                factoryOee = factoryOee / totalValidShifts;
                factoryAvgEl.textContent = factoryOee.toFixed(2) + '%';
                factoryCard.style.display = 'block';
            } else {
                factoryCard.style.display = 'none';
            }
        }

        // Export to Excel (unchanged, works for all as it's local)
        function exportToExcel() {
            if (!isWriter() && confirm('Export is read-only. Continue?')) {
                // Proceed
            } else if (!isWriter()) {
                return;
            }
            const wb = XLSX.utils.book_new();
            const summaryData = [
                ["JPI OEE Export", ""], ["Generated", new Date().toLocaleString('en-US', { timeZone: 'Asia/Colombo' })], [""],
                ["Section", "OEE Avg", "A Avg", "P Avg", "Q Avg", "Machines"]
            ];
            ['day', 'night'].forEach(shift => {
                ['im', 'bm', 'iml'].forEach(sec => {
                    const el = (id) => document.getElementById(id);
                    summaryData.push([
                        `${sec.toUpperCase()} ${shift.toUpperCase()}`,
                        el(`oee-${sec}-${shift}`).textContent,
                        el(`a-${sec}-${shift}`).textContent,
                        el(`p-${sec}-${shift}`).textContent,
                        el(`q-${sec}-${shift}`).textContent,
                        el(`count-${sec}-${shift}`).textContent
                    ]);
                });
            });
            summaryData.push(["", "", "", "", "", ""]);
            summaryData.push(["Day Shift OEE", document.getElementById('avg-day').textContent || "N/A"]);
            summaryData.push(["Night Shift OEE", document.getElementById('avg-night').textContent || "N/A"]);
            summaryData.push(["Factory OEE", document.getElementById('avg-factory').textContent || "N/A"]);
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), "Summary");
            const headers = ["ID", "Name", "OEE", "A", "P", "Q", "Planned", "Target/Hr", "Cavity", "Breakdown", "Mould", "No Op", "Clear", "Start", "Other", "Damage"];
            const map = { im: "IM", bm: "BM", iml: "IML" };
            ['day', 'night'].forEach(shift => {
                ['im', 'bm', 'iml'].forEach(sec => {
                    const rows = [headers];
                    machineData[shift][sec].forEach((m, i) => {
                        if (m.hasData) {
                            rows.push([
                                `${map[sec]} ${shift.toUpperCase()} ${i+1}`, m.name || "", m.oee.toFixed(2), m.a.toFixed(2), m.p.toFixed(2), m.q.toFixed(2),
                                m.plannedQty, m.targetPerHour, m.cavityCount, m.breakdownTime, m.mouldChangeTime,
                                m.lackOperatorTime, m.itemClearTime, m.machineStartedTime, m.othersTime, m.damageQty
                            ]);
                        }
                    });
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), `${shift.toUpperCase()} ${map[sec]}`);
                });
            });
            XLSX.writeFile(wb, `JPI_OEE_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // Page Navigation (updated to hide login on home)
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'home') {
                document.getElementById('oee-charts').style.display = 'none';
                document.querySelector('.show-oee-btn').innerHTML = '<i class="fas fa-chart-line"></i> Show OEE Graphs';
                document.getElementById('search-results').style.display = 'none';
                chartsVisible = false;
                document.getElementById('machine-container').innerHTML = '';
                document.getElementById('section-title').innerHTML = '';
                currentSection = null;
                document.getElementById('login-section').style.display = 'none';
                updateAverages();
                window.scrollTo(0, 0);
            }
        }

        // Charts (unchanged)
        function toggleOEECharts() {
            const div = document.getElementById('oee-charts');
            const btn = document.querySelector('.show-oee-btn');
            if (chartsVisible) {
                div.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-chart-line"></i> Show OEE Graphs';
                chartsVisible = false;
            } else {
                div.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-chart-line"></i> Hide OEE Graphs';
                chartsVisible = true;
                updateCharts();
            }
        }
        function updateCharts() {
            ['day', 'night'].forEach(shift => {
                ['im', 'bm', 'iml'].forEach(sec => {
                    const data = machineData[shift][sec];
                    const labels = [], values = [];
                    data.forEach((m, i) => {
                        if (m.hasData && m.oee > 0) {
                            labels.push(m.name || `${sec.toUpperCase()} ${i+1}`);
                            values.push(m.oee);
                        }
                    });
                    const chartId = `${sec}Chart-${shift}`;
                    const ctx = document.getElementById(chartId).getContext('2d');
                    if (charts[chartId]) charts[chartId].destroy();
                    charts[chartId] = new Chart(ctx, {
                        type: 'bar',
                        data: { labels: labels.length ? labels : ['No Data'], datasets: [{ label: 'OEE %', data: values.length ? values : [0], backgroundColor: 'rgba(67,97,238,0.7)', borderColor: 'rgba(67,97,238,1)', borderWidth: 1, borderRadius: 6, maxBarThickness: 40 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } } }
                    });
                });
            });
        }

        // Machine Entry (updated: inputs read-only if not writer)
        function initSection(type, count, label, icon) {
            if (!isWriter()) {
                alert('Login required to enter/edit data.');
                showLogin();
                return;
            }
            currentShift = document.getElementById('shiftSelector').value;
            currentSection = type; totalMachines = count;
            document.getElementById('section-title').innerHTML = `<i class="${icon} me-2"></i>${label} (${currentShift.toUpperCase()}) – Machine <span id="current-num">1</span> of ${count}`;
            showPage('section-page');
            loadMachine(0);
        }
        function loadMachine(index) {
            if (!isWriter()) return; // Safety
            currentIndex = index;
            const container = document.getElementById('machine-container');
            container.innerHTML = '';
            const machineNum = index + 1;
            const type = currentSection.toUpperCase();
            const saved = machineData[currentShift][currentSection][index];
            const card = document.createElement('div');
            card.className = 'machine-container';
            card.innerHTML = `
                <div class="machine-header">
                    <h3><i class="fas fa-microchip"></i> ${type} ${machineNum}</h3>
                    <input type="text" placeholder="Enter name" value="${saved.name}" class="form-control name-input">
                </div>
                <div class="section-title"><i class="fas fa-clock"></i>1. Available Time</div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="input-group"><span class="input-group-text">Planned Qty</span><input type="number" min="0" class="form-control plannedQty" value="${saved.plannedQty}"></div>
                        <div class="input-group mt-2"><span class="input-group-text">Target / Hour</span><input type="number" min="0" class="form-control targetPerHour" value="${saved.targetPerHour}"></div>
                        <div class="input-group mt-2"><span class="input-group-text">Cavity Count</span><input type="number" min="1" class="form-control cavityCount" value="${saved.cavityCount}"></div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group"><span class="input-group-text">Breakdown (min)</span><input type="number" min="0" class="form-control breakdownTime" value="${saved.breakdownTime}"></div>
                        <div class="input-group mt-2"><span class="input-group-text">Mould Change (min)</span><input type="number" min="0" class="form-control mouldChangeTime" value="${saved.mouldChangeTime}"></div>
                    </div>
                </div>
                <div class="alert mt-3"><strong>Available Time = ((Planned Qty / Target per Hour) / Cavity) × 60 min</strong></div>
                <div class="section-title"><i class="fas fa-tachometer-alt"></i>2. Run Time</div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="input-group"><span class="input-group-text">No Operator (min)</span><input type="number" min="0" class="form-control lackOperatorTime" value="${saved.lackOperatorTime}"></div>
                        <div class="input-group mt-2"><span class="input-group-text">Item Clear (min)</span><input type="number" min="0" class="form-control itemClearTime" value="${saved.itemClearTime}"></div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group"><span class="input-group-text">Machine Start (min)</span><input type="number" min="0" class="form-control machineStartedTime" value="${saved.machineStartedTime}"></div>
                        <div class="input-group mt-2"><span class="input-group-text">Other Delay (min)</span><input type="number" min="0" class="form-control othersTime" value="${saved.othersTime}"></div>
                    </div>
                </div>
                <div class="section-title"><i class="fas fa-times-circle"></i>3. Quality</div>
                <div class="input-group">
                    <span class="input-group-text">Damage Qty</span>
                    <input type="number" min="0" class="form-control damageQty" value="${saved.damageQty}">
                    <span class="quality-ok ms-2" style="display:none;">OK</span>
                </div>
                <div class="alert mt-3"><strong>Damage Time = ((Damage Qty / Target per Hour) / Cavity) × 60</strong></div>
                <div class="metrics-grid">
                    <div class="metric-card"><div class="metric-label">Availability</div><div class="metric-value" id="ar">0.00%</div></div>
                    <div class="metric-card"><div class="metric-label">Performance</div><div class="metric-value" id="pr">0.00%</div></div>
                    <div class="metric-card"><div class="metric-label">Quality</div><div class="metric-value" id="qr">100.00%</div></div>
                    <div class="metric-card"><div class="metric-label">OEE</div><div class="metric-value metric-oee" id="oee">0.00%</div></div>
                </div>
                <div class="nav-controls">
                    <button class="nav-btn" id="prev-btn">Previous</button>
                    <div class="machine-counter">Machine <strong>${machineNum}</strong> of <strong>${totalMachines}</strong></div>
                    <button class="nav-btn" id="next-btn">Next</button>
                </div>
            `;
            container.appendChild(card);
            document.getElementById('current-num').textContent = machineNum;
            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').disabled = index === totalMachines - 1;
            card.scrollIntoView({ behavior: 'smooth' });
            const inputs = card.querySelectorAll('input');
            const nameInput = card.querySelector('.name-input');
            const arEl = card.querySelector('#ar');
            const prEl = card.querySelector('#pr');
            const qrEl = card.querySelector('#qr');
            const oeeEl = card.querySelector('#oee');
            const qualityIcon = card.querySelector('.quality-ok');

            // If not writer, make inputs read-only (but since initSection checks, this is backup)
            if (!isWriter()) {
                inputs.forEach(input => input.disabled = true);
                nameInput.disabled = true;
            }

            // ENTER KEY → JUMP TO NEXT FIELD (only if writer)
            if (isWriter()) {
                inputs.forEach((input, i) => {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const next = inputs[i + 1];
                            if (next) {
                                next.focus();
                                next.select && next.select();
                            } else {
                                if (currentIndex < totalMachines - 1) {
                                    nextMachine();
                                }
                            }
                        }
                    });
                });
            }

            function updateMetrics() {
                if (!isWriter()) return;
                const get = (cls, def = 0) => parseFloat(card.querySelector(cls).value) || def;
                const plannedQty = get('.plannedQty');
                const targetPH = get('.targetPerHour');
                const cavity = get('.cavityCount', 1);
                const breakdown = get('.breakdownTime');
                const mould = get('.mouldChangeTime');
                const lackOp = get('.lackOperatorTime');
                const clear = get('.itemClearTime');
                const started = get('.machineStartedTime');
                const others = get('.othersTime');
                const damage = get('.damageQty');
                let a = 0, p = 0, q = 100, oee = 0;
                if (plannedQty && targetPH && cavity > 0) {
                    const availableTime = ((plannedQty / targetPH) / cavity) * 60;
                    const runTime = Math.max(0, availableTime - breakdown - mould);
                    a = availableTime > 0 ? (runTime / availableTime) * 100 : 0;
                    const netOpTime = Math.max(0, runTime - lackOp - clear - started - others);
                    p = runTime > 0 ? (netOpTime / runTime) * 100 : 0;
                    const damageTime = ((damage / targetPH) / cavity) * 60;
                    const effectiveTime = Math.max(0, netOpTime - damageTime);
                    q = netOpTime > 0 ? (effectiveTime / netOpTime) * 100 : 100;
                    oee = (a * p * q) / 10000;
                }
                arEl.textContent = a.toFixed(2) + '%';
                prEl.textContent = p.toFixed(2) + '%';
                qrEl.textContent = q.toFixed(2) + '%';
                oeeEl.textContent = oee.toFixed(2) + '%';
                qualityIcon.style.display = (damage > 0 && targetPH > 0) ? 'inline' : 'none';
                const hasData = plannedQty > 0 || targetPH > 0;
                machineData[currentShift][currentSection][index] = {
                    oee: parseFloat(oee.toFixed(2)),
                    a: parseFloat(a.toFixed(2)),
                    p: parseFloat(p.toFixed(2)),
                    q: parseFloat(q.toFixed(2)),
                    name: nameInput.value.trim() || `${type} ${machineNum}`,
                    hasData,
                    plannedQty, targetPerHour: targetPH, cavityCount: cavity,
                    breakdownTime: breakdown, mouldChangeTime: mould,
                    lackOperatorTime: lackOp, itemClearTime: clear,
                    machineStartedTime: started, othersTime: others, damageQty: damage
                };
                saveData();
                updateAverages();
                if (chartsVisible) updateCharts();
            }

            // Event listeners only if writer
            if (isWriter()) {
                inputs.forEach(i => i.addEventListener('input', updateMetrics));
                nameInput.addEventListener('input', updateMetrics);
            }

            card.querySelector('#prev-btn').onclick = () => { if (currentIndex > 0) loadMachine(currentIndex - 1); };
            card.querySelector('#next-btn').onclick = () => { if (currentIndex < totalMachines - 1) loadMachine(currentIndex + 1); };
            updateMetrics();
        }
        function prevMachine() { if (currentIndex > 0) loadMachine(currentIndex - 1); }
        function nextMachine() { if (currentIndex < totalMachines - 1) loadMachine(currentIndex + 1); }

        // Search (unchanged)
        const searchInput = document.querySelector('.search-input');
        const searchResults = document.getElementById('search-results');
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim().toLowerCase();
            searchResults.innerHTML = ''; searchResults.style.display = 'none';
            if (!query) return;
            const results = [];
            ['day', 'night'].forEach(shift => {
                ['im', 'bm', 'iml'].forEach(sec => {
                    machineData[shift][sec].forEach((m, i) => {
                        const id = `${sec.toUpperCase()} ${i+1}`;
                        const name = (m.name || id).toLowerCase();
                        if ((name.includes(query) || id.toLowerCase().includes(query)) && m.hasData) {
                            results.push({ sec, i, shift, name: m.name || id, oee: m.oee });
                        }
                    });
                });
            });
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="no-results">No machine found.</div>';
                searchResults.style.display = 'block';
                return;
            }
            results.forEach(r => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<div><div class="search-result-name">${r.name}</div><small class="text-muted">${r.sec.toUpperCase()} - ${r.shift.toUpperCase()}</small></div><div class="search-result-oee">${r.oee.toFixed(1)}%</div>`;
                item.onclick = () => {
                    if (!isWriter()) {
                        alert('Login required to view/edit machine details.');
                        showLogin();
                        return;
                    }
                    document.getElementById('shiftSelector').value = r.shift;
                    initSection(r.sec, r.sec === 'im' ? 33 : r.sec === 'bm' ? 17 : 10,
                        r.sec === 'im' ? 'Injection Molding (IM)' : r.sec === 'bm' ? 'Blow Molding (BM)' : 'In-Mold Labeling (IML)',
                        r.sec === 'im' ? 'fas fa-industry' : r.sec === 'bm' ? 'fas fa-wind' : 'fas fa-tag');
                    setTimeout(() => loadMachine(r.i), 100);
                };
                searchResults.appendChild(item);
            });
            searchResults.style.display = 'block';
        });
        document.addEventListener('click', e => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) searchResults.style.display = 'none';
        });

        // Scroll to top (unchanged)
        const scrollTop = document.getElementById('scrollTop');
        window.addEventListener('scroll', () => {
            scrollTop.style.display = window.scrollY > 500 ? 'flex' : 'none';
        });
        scrollTop.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

        // INIT - Load from Firebase on start (unchanged)
        loadData();
// === DATE PICKER INITIALIZATION ===
const datePicker = document.getElementById('datePicker');

// Set default to today (or your desired date)
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, '0');
const dd = String(today.getDate()).padStart(2, '0');
datePicker.value = `${yyyy}-${mm}-${dd}`;  // Shows November 20, 2025 if today is that date

// Optional: Do something when date changes
datePicker.addEventListener('change', function() {
    const selectedDate = this.value;
    const formatted = new Date(selectedDate).toLocaleDateString('en-GB', {
        day: '2-digit', month: 'short', year: 'numeric'
    });
    console.log('Selected Date:', formatted);
    // You can later use this date for filtering data, export filename, etc.
    // Example: alert(`Dashboard now showing data for: ${formatted}`);
});
    </script>
</body>
</html>
